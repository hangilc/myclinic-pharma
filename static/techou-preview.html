<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>薬手帳プレビュー</title>
</head>
<body>
<div>
    <button id="print-button">印刷</button>
</div>
<div id="preview-area"></div>
<script src="techou-bundle.js"></script>
<script>
/*
function parseQuery(){
    var q = location.search;
    q = q.replace(/^\?/, "");
    var parts = q.split("&");
    var dict = {};
    parts.forEach(function(part){
        var toks = part.split("=");
        var key = toks[0], val = toks[1];
        dict[key] = parseValue(val);
    });
    return dict;
    
    function parseValue(val){
        var n = Number(val);
        if( !isNaN(n) ){
            return n;
        }
        return val;
    }
}

var theVisitId = parseQuery().visit_id;
var theOps = [];

function request(service, data, method){
    data = data || {};
    method = method || "GET";
    return new Promise(function(resolve, reject){
        $.ajax({
            url: "/service?_q=" + service,
            type: method,
            data: data,
            dataType: "json",
            success: function(list){
                resolve(list);
            },
            error: function(xhr){
                reject(xhr.responseText);
            }
        })
    });
}

request("drug_techou_ops", {visit_id: theVisitId})
.then(function(ops){
    var svg = drawerToSvg(ops, {width: "105mm", height: "148mm", viewBox: "0 0 105 148"});
    var wrapper = $("#preview-area");
    wrapper.html("").append(svg);
    theOps = ops;
});

(function(settingKey){
    "use strict";
    var setting = localStorage.getItem(settingKey);
    
    $("#printer-setting-disp").text(setting || "(no printer setting)");
    
    $("#print-button").click(function(event){
        if( !theOps ) return;
		event.preventDefault();
		$.ajax({
			url: "http://localhost:9006/print",
			type: "POST",
			data: JSON.stringify({
				pages: [theOps],
				setting: setting
			}),
			success: function(result){
                window.close();
				console.log(result);
			},
			error: function(xhr){
				console.log(xhr.responseText);
			}
		});
        
    });
    
})(pharmalib.DRUG_TECHOU_PRINTER_SETTING);
*/
</script>
</body>
</html>
